{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">
    <!-- User Profile Card -->
    <div class="profile-card container">
        <div class="profile-avatar">
            <img src="{{ user.avatar_url }}">
        </div>
        <div class="profile-info">
            <div class="profile-name-row">
                <h2 class="profile-name">{{user_profile.nickname}}</h2>
                <form method="post" action="{% url 'update_user_data' %}" class="update-form">
                    {% csrf_token %}
                    <button type="submit" class="btn-update" title="Update user data">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.5 2v6h-6"/>
                            <path d="M2.5 22v-6h6"/>
                            <path d="M2 11.5C2 6.3 6.3 2 11.5 2c3.1 0 5.8 1.5 7.5 3.8"/>
                            <path d="M22 12.5c0 5.2-4.3 9.5-9.5 9.5-3.1 0-5.8-1.5-7.5-3.8"/>
                        </svg>
                    </button>
                </form>
                <form method="post" id="deleteProfileForm" action="{%url 'delete_profile'%}" class="hidden-form">
                    {% csrf_token %}
                </form>
                <div class="delete-profile">
                    <button id="deleteProfileBtn">Delete profile</button>
                </div>
            </div>
            <div class="logout-window">
                <dialog id="deleteProfileDialog" class="logout-dialog">
                    <div class= "logout-confirmation">
                        <p >Are you sure you want to delete your profile?</p>
                        <div class="dialog-buttons">
                            <button id="cancelDeleteBtn" class="cancel-button">Cancel</button>
                            <button id="confirmDeleteBtn" class="confirm-button">Delete</button>
                        </div>
                    </div>
                </dialog>
            </div>
            <p class="profile-realname">{{user_profile.realname}}</p>
            <p class="profile-since">Steam user since {{user_profile.steam_user_since}}</p>
        </div>
        <div class="profile-stats">
            <div class="stat-item">
                <div class="stat-value">{{total_hours}}</div>
                <div class="stat-label">Total playtime</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{games_count}}</div>
                <div class="stat-label">Games in library</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{not_completed_games_count}}</div>
                <div class="stat-label">Unfinished games</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{not_played_games_count}}</div>
                <div class="stat-label">Not played games</div>
            </div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="dashboard-grid">
        <!-- Left Column -->
        <div class="dashboard-left">
            <!-- Playtime Distribution -->
            <div class="card card-chart">
                <h3 class="card-title">Time spent by game</h3>
                <canvas id="playtime-doughnut" width="400" height="250"></canvas>
                {{chart_labels|json_script:"chart_labels" }}
                {{chart_values|json_script:"chart_values" }}
                {{chart_hours|json_script:"chart_hours" }}
                <div class="chart-placeholder">
                    <div class="chart-legend"> 
                    </div>
                </div>
            </div>
            
            <!-- Unfinished Games -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Potentially unfinished games</h3>
                    <button class="btn-view-all"><a href="{%url 'library' %}?filter=not_completed">View all</a></button>
                </div>
                <div class="game-list">
                    {%for g in not_completed_games%}
                        <div class="game-list-item">
                            <div class="game-list-item-icon"><img src="{{ g.game.logo_url }}" alt="{{ g.game.name }}"></div>
                            <div class="game-list-item-info">
                                <div class="game-list-item-name">{{g.game.name}}</div>
                                <div class="game-list-item-time">
                                    Total: {{g.playtime_hours}}h • 
                                    Recent: {{g.recent_playtime_hours}}h •
                                    Last played: {% if g.last_played %}{{ g.last_played|timesince }} ago{% else %}Never{% endif %}
                                </div>
                            </div>
                        </div>
                    {%endfor%}
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Not played games</h3>
                    <button class="btn-view-all"><a href="{% url 'library' %}?filter=not_played">View all</a></button>
                </div>
                <div class="game-list">
                    {%for g in not_played_games%}
                        <div class="game-list-item">
                            <div class="game-list-item-icon"><img src="{{ g.game.logo_url }}" alt="{{ g.game.name }}"></div>
                            <div class="game-list-item-info">
                                <div class="game-list-item-name">{{g.game.name}}</div>
                                <div class="game-list-item-time">
                                    Last played: {% if g.last_played %}{{ g.last_played|timesince }} ago{% else %}Never{% endif %}
                                </div>
                            </div>
                        </div>
                    {%endfor%}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="dashboard-right">
            <!-- Favorite Games -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Favorite games</h3>
                    <button class="btn-view-all"><a href="{% url 'library' %}">View all</a></button>
                </div>
                <div class="game-list">
                    {%for g in favorite_games%}
                        <div class="game-list-item">
                            <div class="game-list-item-icon"><img src="{{ g.game.logo_url }}" alt="{{ g.game.name }}"></div>
                            <div class="game-list-item-info">
                                <div class="game-list-item-name">{{g.game.name}}</div>
                                <div class="game-list-item-time">
                                    Total: {{g.playtime_hours}}h • 
                                    Recent: {{g.recent_playtime_hours}}h • 
                                    Last played: {% if g.last_played %}{{ g.last_played|timesince }} ago{% else %}Never{% endif %}
                                </div>
                            </div>
                        </div>
                    {%endfor%}
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent activity</h3>
                </div>
                <div class="game-list">
                    {%for g in recent_games%}
                        <div class="game-list-item">
                            <div class="game-list-item-icon"><img src="{{ g.game.logo_url }}" alt="{{ g.game.name }}"></div>
                            <div class="game-list-item-info">
                                <div class="game-list-item-name">{{g.game.name}}</div>
                                <div class="game-list-item-time">
                                    Last played: {% if g.last_played %}{{ g.last_played|timesince }} ago{% else %}Never{% endif %} •
                                    Recent: {{g.recent_playtime_hours}}h •
                                    Total: {{g.playtime_hours}}h  
                                </div>
                            </div>
                        </div>
                    {%endfor%}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{%block extra_js%}
    <script src="{% static 'js/chart.js' %}"></script>
    <script src="{% static 'js/draw_doughnut_chart.js' %}"></script>
    <script src="{% static 'js/delete_profile.js' %}"></script>
    <script src="{% static 'js/update_button_loading_state.js' %}"></script>
{%endblock%}